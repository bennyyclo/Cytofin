
<!-- README.md is generated from README.Rmd. Please edit that file -->

# cytofin

CytofIN (CyTOF integration) is an R package for homogenizing and
normalizing heterogeneous [mass cytometry
(CyTOF)](https://pubmed.ncbi.nlm.nih.gov/21551058/) data from diverse
data sources. Specifically, CytofIN provides functions that perform the
following tasks:

-   **Dataset homogenization** - CyTOF datasets that were collected
    separately may differ in which markers were included in their
    antibody panels; in addition, they may use different naming
    conventions for their panels’ shared markers. Thus, data mining
    across multiple CyTOF datasets requires **homogenization,** the
    process of aligning each dataset’s antibody panels so that they can
    be analyzed together. In CytofIN, data homogenization (i.e. panel
    alignment) is performed with the `cytofin_homogenize()` function
    that leverages user-provided panel information to combine datasets.
-   **Dataset normalization** - Combined analysis of multiple CyTOF
    datasets is likely to be confounded by dataset-to-dataset batch
    effects due to differences in instrumentation and experimental
    protocols between groups. To normalize multiple CyTOF datasets with
    respect to these batch effects, CytofIN provides 3 functions:
    `cytofin_anprep()`, `cytofin_annorm()`, and `cytofin_annorm_nrs()`.

The general CytofIN workflow unfolds in 3 steps. First, users align the
panels of the CyTOF datasets being integrated using
`cytofin_homogenize()`. Second, users generate reference statistics from
“generalized anchors” identified on each CyTOF plate (see below) using
`cytofin_anchor_prep()`. Finally, users can then normalize/batch correct
the datasets relative to one another using their choice of
`cytofin_normalize()` or `cytofin_normalize_nrs()`, each of which
performs the normalization slightly differently (see below).

## Installation

To install CytofIN, run the following code:

``` r
library(devtools)
install_github("bennyyclo/Cytofin")
```

To attach the Cytofin package to your current R session, run the
following:

``` r
library(cytofin)
```

## Usage

### CyTOF data homogenization

![](./images/Slide1.png?raw=true "Title")

Description: the homognize function takes a user input antigen panel
table, which includes standardized antigen name and associated antigen
search pattern. Given two CyTOF files with distinct antigen naming, the
program performs a regular expression search to match the synonymous
term in the panel and correct the antigen name with standardized names
in the panel.

Function Definition:

`homogenize(metadata_filename, panel_filename, input_file_dir, output_file_dir)`

Input:

`metadata_file`: metadata table of raw CyTOF files (.fcs)(must be in the
current directory).

`panel_filename`: standardized antigen panel table file
(.xlsx/.csv)(must be in the current directory).

`input_file_dir`: folder directory containing input raw CyTOF files.

`output_file_dir`: folder directory containing output homogenized files.

Output: homogenized CyTOF file with user-defined channels presented in
the standardized antigen table.

**CyTOF data normalization using external anchors**

![Alt text](./images/Slide2.PNG?raw=true "Title")

The external anchor normalization steps include: 1. preparation of
external anchors and 2. application of transformation function.

1.  Anchors preparation:

Description: the anprep function concatenates the identified anchor
file, one file per plate/batch, and subsequently generates summary
statistics including mean and variance which will be used for batch
correction.

Function definition:

`anprep(metadata_filename, panel_filename, input_file_dir)`

Input:

`metadata_filename`: metadata table of anchor CyTOF files (.fcs)(must be
in the current directory).

`panel_filename`: standardized antigen panel table file
(.xlsx/.csv)(must be in the current directory).

`input_file_dir`: folder directory containing output data.

Output: an RData object containig reference statistics and concatenated
anchor FCS files.

1.  Data transformation:

Description: the annorm function applied different transformation
functions (modes) to normalize each anchor to the referenece statistcs
generated by the anprep function.

Function definition:

`annorm (control_metadata_filename, control_data_filename, sample_metadata_filename, panel_filename, input_file_dir, val_file_dir="none" ,output_file_dir, mode)`

Input:

`control_metadata_file`: metadata table of anchor CyTOF files
(.fcs)(must be in the current directory).

`control_data_filename`: RData object containing anchor referene
statistics (must be in the current directory).

`sample_metadata_filename`: metadata table of homogenized CyTOF files
(.fcs)(must be in the current directory).

`panel_filename`: standardized antigen panel table file
(.xlsx/.csv)(must be in the current directory).

`input_file_dir`: folder directory containing input homogenized CyTOF
data file.

`val_file_dir`: folder directory containing validation homogenized CyTOF
data file (optional).

`output_file_dir`: folder directory containing output normalized CyTOF
data file.

`mode`: transformation function used for normaliztion (*meanshift*,
*meanshift\_bulk*, *variance*, *z\_score*, *beadlike*).

Output: normalized CyTOF files.

**CyTOF data normalization using internal anchors**

![Alt text](./images/Slide3.PNG?raw=true "Title")

Description: In the event that the external references are not
available, internal anchors can be used. Here, we identified the most
stable channels as internal anchors using a PCA-based non-redundnacy
score (NRS). A minimal of three channels should be selected to establish
an internal refernece from which signal can be calibrated between CyTOF
files.

Function definition:

`annorm_nrs(sample_metadata_filename, panel_filename, input_file_dir, val_file_dir="none", output_file_dir, nchannels)`

Input:

`sample_meta_filename`: metadata table of homogenized CyTOF files
(.fcs)(must be in the current directory).

`panel_filename`: standardized antigen panel table file
(.xlsx/.csv)(must be in the current directory).

`val_file_dir`: folder directory containing validation homogenized CyTOF
data file (optional).

`output_file_dir`: folder directory containing output normalized CyTOF
data file.

`nchannels`: number of stabilized channels used for normalization.

Output: normalized CyTOF files.

**Computational pipeline for CyTOF data integration**

Below is a demo Rscript using CytofIN package for CyTOF data
integration.

    #import cytofin R package
    library(cytofin)

    #homogenization antigen panel, use the demo data supplied with the package
    metadata_filename <- paste0(path.package("cytofin"),"/extdata/test_metadata_raw.csv")
    panel_filename <- paste0(path.package("cytofin"),"/extdata/test_panel.csv")
    input_file_dir <- paste0(path.package("cytofin"),"/extdata/test_raw_fcs_files/")
    output_file_dir <- "out_test/"
    homogenize(metadata_filename, panel_filename, input_file_dir, output_file_dir)

    #prep external anchor 
    anchor_metadata_filename <- paste0(path.package("cytofin"),"/extdata/test_anchor_metadata_raw.csv")
    input_file_dir <- output_file_dir #use the homogenized files
    anprep(anchor_metadata_filename, panel_filename, input_file_dir)

    #data normalization using external anchors and meanshift transofmration function
    val_file_dir <- paste0(path.package("cytofin"),"/extdata/test_batch_fcs_files/")
    anchor_data_filename <- "./Prep_control.RData"
    output_file_dir <- "norm_test/"
    mode <- "meanshift"
    annorm(anchor_metadata_filename, anchor_data_filename, metadata_filename, panel_filename, 
    input_file_dir, val_file_dir, output_file_dir, mode)
    annorm(anchor_metadata_filename, anchor_data_filename, metadata_filename, panel_filename, 
    input_file_dir, "none", output_file_dir, mode)

    #data normalization using 4 internal channels and meanshift_bulk transformation function
    nchannels <- 4
    output_file_dir <- "norm_test2/"
    annorm_nrs(metadata_filename, panel_filename, input_file_dir, val_file_dir, 
    output_file_dir, nchannels)
    annorm_nrs(metadata_filename, panel_filename, input_file_dir, "none", 
    output_file_dir, nchannels)
